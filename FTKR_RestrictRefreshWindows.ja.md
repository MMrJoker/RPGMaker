[トップページに戻る](README.md)

# [FTKR_RestrictRefreshWindows](FTKR_RestrictRefreshWindows.js) プラグイン

各画面におけるウィンドウのリフレッシュ回数を制限して負荷を抑えます。

ダウンロード: [FTKR_RestrictRefreshWindows.js](https://raw.githubusercontent.com/futokoro/RPGMaker/master/FTKR_RestrictRefreshWindows.js)

## 目次

以下の項目の順でプラグインの使い方を説明します。
1. [概要](#概要)
2. [プラグインの登録](#プラグインの登録)
1. [装備画面の負荷軽量化](#装備画面の負荷軽量化)
* [プラグインの更新履歴](#プラグインの更新履歴)
* [ライセンス](#ライセンス)

## 概要

このプラグインを導入すると、各画面におけるウィンドウのリフレッシュ回数を制限して負荷を抑えます。

対象画面
* 装備画面

[目次に戻る](#目次)

## プラグインの登録

このプラグインはできる限り、プラグイン管理の一番下に登録してください。

[目次に戻る](#目次)

# 装備画面の負荷軽量化

装備画面の場合の各操作とその時のウィンドウの再描画回数は、調べたところ以下のようになっている。<br>
⇒矢印以降の数値は、このプラグイン導入による修正後の回数。

| 操作 | status | item | help | slot |
| --- | --- | --- | --- | --- |
| メニュー画面から装備画面に移る | ２回⇒１回 | ２回⇒０回 | ０回 | ２回⇒１回 |
| 装備コマンドを選択 | ０回 | １回 | １回 | ０回 |
| 最強装備コマンドを選択 | １回 | ０回 | ０回 | １回 |
| 全て外すコマンドを選択 | １回 | ０回 | ０回 | １回 |
| コマンドウィンドウでキャンセル | ０回 | ０回 | ０回 | ０回 |
| 装備スロットでカーソルを動かす | ０回 | １回 | １回 | ０回 |
| 装備スロットでスロットを選択 | ２回⇒１回 | ０回 | ２回⇒１回 | ０回 |
| 装備スロットでキャンセル | ０回 | １回 | １回 | ０回 |
| アイテムウィンドウでカーソルを動かす | １回 | ０回 | １回 | ０回 |
| アイテムウィンドウでアイテムを選択 | ２回⇒１回 | １回 | ２回⇒１回 | １回 |
| アイテムウィンドウでキャンセル | １回 | ０回 | ２回⇒１回 | ０回 |

* status ：装備ステータスウィンドウ
* item ：装備アイテムウィンドウ
* help ：ヘルプウィンドウ
* slot ：装備スロットウィンドウ

## 修正内容の解説

### メニュー画面から装備画面に移って来た時の装備アイテムウィンドウ描画について
装備画面に移ってきた時に装備アイテムウィンドウを２回描画している。
* `Scene_Equip`の`refreshActor()`で、`this._itemWindow.setActor(actor)`を実行したタイミング
* `Scene_Equip`の初期か処理が終了して`update()`が走った際に、装備スロットウィンドウのカーソル位置情報(初期値=-1)を参照して、`this._itemWindow._slotId = -1`に更新したことで再描画。

この２回の描画は、正確には１回目で装備アイテムを表示させて、２回目でそれを消す、という処理になっている。
その結果、装備アイテムウィンドウが空欄になるため、そもそも描画処理を実行する意味がない。

よって、このタイミングでは描画しないように修正した。

１回目については、`this._itemWindow.setActor()`内で`this._itemWindow.refresh()`を実行しないように無効化処理(*1)を追加。

*1:`refresh()`メソッド内に、特定のフラグ(`_disabledRefresh`)が`true`になっていると内部の処理を実行しないような修正を加えています。

２回目については、`this._itemWindow._slotId`の初期値を`-1`に設定しておくことで、更新されないようにした。

### その他のタイミングでの各ウィンドウの２回描画について

どのタイミングでも１回目の描画は必要ないため、実行しないように無効化している。

## 残件

装備画面の負荷を重くしている理由には、ウィンドウの再描画回数だけではなく、以下の処理もある。

* 選択中のアイテム装備後のパラメータを参照するためにダミーのアクターデータが存在しており、２人分のアクターデータを表示している
* 装備アイテムウィンドウでカーソルを動かす度に、このダミーアクターデータを作り直し⇒ウィンドウを再描画という処理を行っている

装備アイテムウィンドウでカーソルを動かす処理が重い理由は、この部分の影響も大きい。
再描画はどうしようもないため、ダミーデータの作り直しを見直して負荷を抑えたい。

[目次に戻る](#目次)

# プラグインの更新履歴

| バージョン | 公開日 | 更新内容 |
| --- | --- | --- |
| [ver1.0.1](FTKR_RestrictRefreshWindows.js) | 2018/12/15 | 装備画面のアイテムウィンドウのリフレッシュの挙動を修正 |
| ver1.0.0 | 2018/12/15 | 新規作成 |

# ライセンス

本プラグインはMITライセンスのもとで公開しています。

[The MIT License (MIT)](https://opensource.org/licenses/mit-license.php)

#
[目次に戻る](#目次)

[トップページに戻る](README.md)